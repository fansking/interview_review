## 一致性哈希

介绍一致性hash算法（Consistent Hashing）及其在分布式缓存中的应用

当新加入节点时，数据改动不会太大。

一致性哈希算法对于节点的增减都只需重定位环空间中的一小部分数据，具有较好的容错性和可扩展性。

**数据倾斜问题**

解决办法-虚拟节点

一致性哈希算法在服务节点太少时，容易因为节点分部不均匀而造成数据倾斜问题。例如我们的系统中有两台服务器，其环分布如下：



![img](https://ask.qcloudimg.com/http-save/developer-news/iukgy7udpr.jpeg?imageView2/2/w/1620)

一致性hash函数值空间 (5).png

此时必然造成大量数据集中到Redis-1上，而只有极少量会定位到Redis-0上。

为了解决这种数据倾斜问题，一致性哈希算法引入了虚拟节点机制，即对每一个服务节点计算多个哈希，每个计算结果位置都放置一个此服务节点，称为虚拟节点。具体做法可以在服务器ip或主机名的后面增加编号来实现。例如上面的情况，我们决定为每台服务器计算三个虚拟节点，于是可以分别计算“Redis-1 #1”、“Redis-1 #2”、“Redis-1 #3”、“Redis-0 #1”、“Redis-0 #2”、“Redis-0 #3”的哈希值，于是形成**六个虚拟节点**：



![img](https://ask.qcloudimg.com/http-save/developer-news/mad84x4ozj.jpeg?imageView2/2/w/1620)

一致性hash函数值空间 (6).png

同时数据定位算法不变，只是多了一步虚拟节点到实际节点的映射，例如定位到“Redis-1#1”、“Redis-1#2”、“Redis-1#3”三个虚拟节点的数据均定位到Redis-1上。这样就解决了服务节点少时数据倾斜的问题。在实际应用中，通常将虚拟节点数设置为32甚至更大，因此即使很少的服务节点也能做到相对均匀的数据分布。