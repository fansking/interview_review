## SOA与微服务

SOA可以看作是一套完整的应用，所有的模块都在这一个应用中，是单进程多线程的应用。

而微服务是多个模块同时开发，互不影响，以http请求的轻量级消息进行数据交互，多进程，且可以使用不同的编程语言。

# 高可用性

**一、什么是高可用**

**高可用HA**（High Availability）是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。

假设系统一直能够提供服务，我们说系统的可用性是100%。

如果系统每运行100个时间单位，会有1个时间单位无法提供服务，我们说系统的可用性是99%。

很多公司的高可用目标是4个9，也就是99.99%，这就意味着，系统的年停机时间为8.76个小时。

百度的搜索首页，是业内公认高可用保障非常出色的系统，甚至人们会通过www.baidu.com 能不能访问来判断“网络的连通性”，百度高可用的服务让人留下啦“网络通畅，百度就能访问”，“百度打不开，应该是网络连不上”的印象，这其实是对百度HA最高的褒奖。

 

**二、如何保障系统的高可用**

我们都知道，单点是系统高可用的大敌，单点往往是系统高可用最大的风险和敌人，应该尽量在系统设计的过程中避免单点。方法论上，高可用保证的原则是“集群化”，或者叫“冗余”：只有一个单点，挂了服务会受影响；如果有冗余备份，挂了还有其他backup能够顶上。

**保证系统高可用，架构设计的核心准则是：冗余。**

有了冗余之后，还不够，每次出现故障需要人工介入恢复势必会增加系统的不可服务实践。所以，又往往是通过“自动故障转移”来实现系统的高可用。

接下来我们看下典型互联网架构中，如何通过**冗余+自动故障转移**来保证系统的高可用特性。
### 服务雪崩

服务雪崩，其实指的是服务的调用链路较长时，下游服务不可用而阻塞会影响上游服务，从而导致这个链路中所有的服务阻塞或不可用。

### 服务降级

当服务器压力剧增的情况下，对服务和页面有策略的降级以释放服务器资源和核心任务的运行

1. 服务接口拒绝服务，页面可以访问，但添加删除操作拒绝。
2. 页面拒绝服务
3. 延迟持久化，页面正常访问，但有添加删除操作，异步处理

### 服务熔断

当下游的服务因为某种原因突然**变得不可用**或**响应过慢**，上游服务为了保证自己整体服务的可用性，不再继续调用目标服务，直接返回，快速释放资源。如果目标服务情况好转则恢复调用。

### 服务限流

常见的限流算法有:

1. 计数器算法,限制1s内最大请求数量。缺点是如果1s内前10ms有大量请求，而后面的请求无法响应

2. 漏桶算法，算法内部有一个容器，可以存放已进入的请求，每隔一定时间如10ms，处理一定量的请求。当然如果容器内请求数达到上限就会丢弃新的请求(kafka可实现如此功能)。缺点是面对突发流量无法控制。

3. 令牌桶算法，在令牌桶算法中，存在一个桶，用来存放固定数量的令牌。算法中存在一种机制，以一定的速率往桶中放令牌。每次请求调用需要先获取令牌，只有拿到令牌，才有机会继续执行，否则选择选择等待可用的令牌、或者直接拒绝。

   放令牌这个动作是持续不断的进行，如果桶中令牌数达到上限，就丢弃令牌，所以就存在这种情况，桶中一直有大量的可用令牌，这时进来的请求就可以直接拿到令牌执行，比如设置qps为100，那么限流器初始化完成一秒后，桶中就已经有100个令牌了，这时服务还没完全启动好，等启动完成对外提供服务时，该限流器可以抵挡瞬时的100个请求。所以，只有桶中没有令牌时，请求才会进行等待，最后相当于以一定的速率执行。

