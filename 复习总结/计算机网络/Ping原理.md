## ping原理

首先要知道几个知识点

主机是可以学习MAC地址的（也就是会把不知道的MAC地址保存起来）

在以太网环境中，数据的传输所依懒的是MAC地址而非IP地址，而将已知IP地址转换为MAC地址的工作是由ARP协议来完成的。

#### ARP广播

任何时候，当主机需要找出这个网络中的另一个主机的物理地址时，它就可以发送一个ARP请求报文，这个报文包好了发送方的MAC地址和IP地址以及接收方的IP地址。因为发送方不知道接收方的物理地址，所以这个查询分组会在网络层中进行广播。

#### ARP响应

局域网中的每一台主机都会接受并处理这个ARP请求报文，然后进行验证，查看接收方的IP地址是不是自己的地址，只有验证成功的主机才会返回一个ARP响应报文，这个响应报文包含接收方的IP地址和物理地址。这个报文利用收到的ARP请求报文中的请求方物理地址以单播的方式直接发送给ARP请求报文的请求方。

ping时如果在同一网段则不需要网关转发，发送ARP广播即可

不在同一网段则需要网关转发，先确定网关mac，再发送icmp报文交给路由器

当路由器接收到来自host2的icmp报文之后，发现目的地址的IP为192.168.2.1，查询路由发现，得找一个出去的接口，于是去掉原来的mac地址头，加上自己的mac地址头并且向host3转发，（如果网关也没有host3的mac，也得发送ARP报文问询，并且路由器的端口也能学习主机的mac地址，主机host3也能学习路由器的MAC地址）
主机host3已经学到了路由器的mac，这会就会返回icmp报文

ICMP（Internet Control Message Protocol）Internet控制[报文](https://baike.baidu.com/item/报文/3164352)协议。它是[TCP/IP协议簇](https://baike.baidu.com/item/TCP%2FIP协议簇)的一个子协议，用于在IP[主机](https://baike.baidu.com/item/主机/455151)、[路由](https://baike.baidu.com/item/路由)器之间传递控制消息。控制消息是指[网络通](https://baike.baidu.com/item/网络通)不通、[主机](https://baike.baidu.com/item/主机/455151)是否可达、[路由](https://baike.baidu.com/item/路由/363497)是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。